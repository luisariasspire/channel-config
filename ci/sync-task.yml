platform: linux
image_resource:
  type: docker-image
  source:
    repository: python
    tag: 3.8-alpine
inputs:
  - name: repo
run:
  path: sh
  args:
    - -exc
    - |
      set -ex

      cd repo/lib/channel_config

      apk add gcc musl-dev
      pip install pipenv
      pipenv sync

      pipenv run channel_tool validate # Check that configs are valid

      # TODO Remove --check-only flag
      pipenv run sync_to_tk staging --dry-run --yes
      pipenv run sync_to_tk production --dry-run --yes
